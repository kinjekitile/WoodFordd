@model WaiversViewModel
@{
    ViewBag.Title = "Waivers";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section H1 {
    <h1>Waivers</h1>
}


<div class="box box-primary">
    <div class="box-header with-border">
        <h3 class="box-title">Waivers</h3>
    </div><!-- /.box-header -->

    @foreach (var vg in Model.VehicleGroups) {
        var waivers = Model.Waivers.Where(x => x.VehicleGroupId == vg.Id).ToList();
        <div class="box-body">
            <h4>@vg.Title - @vg.TitleDescription</h4>
            <div id="waivers-list-@vg.Id">
                @foreach (var w in waivers) {
                    <div id="waiver-@w.Id" class="waiver-list">
                        <span><a href="#edit" class="edit-waiver" id="edit-waiver-@w.Id">Edit</a></span>
                        <span>@w.WaiverType.ToString()</span>
                        <span>
                            Cost per day:
                            @(w.CostPerDay.HasValue ? w.CostPerDay.Value.ToString("#,##0.00") : "n/a")
                        </span>
                        <span>
                            Liability:
                            @(w.Liability.HasValue ? w.Liability.Value.ToString("#,##0.00") : "n/a")
                        </span>

                        <span><a href="#delete" class="delete-waiver" id="delete-waiver-@w.Id">Delete</a></span>
                    </div>
                    <div id="edit-form-@w.Id">
                    </div>
                }
            </div>
            <div id="form-@vg.Id"></div>
            <a href="#add" class="add-waiver" id="add-to-group-@vg.Id">Add new Waiver</a>
        </div>
    }

</div>

@section scripts {
    <script type="text/javascript">
        var waiverTypes;

        $(document).ready(function () {
            getWaiverTypes();
            addBehaviour();
        });

        function getWaiverTypes(f, id) {
            $.ajax({
                url: "/Waivers/GetWaiverTypes",
                context: document.body
            }).done(function (data) {
                waiverTypes = data;
                switch (f) {
                    case "add":
                        createAddForm(id);
                        break;

                    case "edit":
                        createEditForm(id);
                        break;
                }
            });
        }

        function getWaiverTypeFromId(id) {
            var res = "";
            if (waiverTypes != undefined) {
                for (var i = 0; i < waiverTypes.length; i++) {
                    if (waiverTypes[i].Id == id) {
                        res = waiverTypes[i].Title;
                    }
                }
            }
            return res;
        }

        function addBehaviour() {
            $(".add-waiver").on("click", function (e) {

                var vehicleGroupId = $(this).attr("id").replace("add-to-group-", "");
                if (waiverTypes == undefined) {
                    getWaiverTypes("add", vehicleGroupId);
                } else {
                    createAddForm(vehicleGroupId);
                }

                e.preventDefault();
                return false;
            });

            $(".edit-waiver").on("click", function (e) {
                var waiverId = $(this).attr("id").replace("edit-waiver-", "");

                if (waiverTypes == undefined) {
                    getWaiverTypes("edit", waiverId);
                } else {
                    createEditForm(waiverId);
                }

                e.preventDefault();
                return false;
            });

            $(".delete-waiver").on("click", function (e) {
                var waiverId = $(this).attr("id").replace("delete-waiver-", "");
                if (confirm("Are you sure you'd like to delete this waiver?")) {
                    deleteWaiver(waiverId);
                }
                e.preventDefault();
                return false;
            });
        }

        function getWaiverDropDownHtml(f, id, selectedValue) {
            switch (f) {
                case "add":
                    var res = "<select id='selAdd-" + id + "'>";
                    for (var i = 0; i < waiverTypes.length; i++) {
                        res += "<option value='" + waiverTypes[i].Id + "'>" + waiverTypes[i].Title + "</option>";
                    }
                    res += "</select>";
                    return res;

                case "edit":
                    var res = "<select id='selEdit-" + id + "'>";
                    for (var i = 0; i < waiverTypes.length; i++) {
                        res += "<option value='" + waiverTypes[i].Id + "'";
                        if (waiverTypes[i].Id == selectedValue) {
                            res += " selected='selected'";
                        }
                        res += ">" + waiverTypes[i].Title + "</option>";
                    }
                    res += "</select>";
                    return res;
            }

        }

        function createAddForm(vehicleGroupId) {
            var addHtml = getWaiverDropDownHtml("add", vehicleGroupId, -1) + "<input type='text' placeholder='Cost Per Day' value='' id='txtAddCost-" + vehicleGroupId + "' /><input type='text' placeholder='Liability' value='' id='txtAddLiability-" + vehicleGroupId + "' /><input id='btnAdd-" + vehicleGroupId + "' type='button' value='Add' /><input id='btnCancel-" + vehicleGroupId + "' type='button' value='Cancel' />";
            $("#form-" + vehicleGroupId).html(addHtml);

            $("#btnAdd-" + vehicleGroupId).on("click", function (e) {
                var waiverTypeId = $("#selAdd-" + vehicleGroupId).val();
                var cost = $("#txtAddCost-" + vehicleGroupId).val();
                var liability = $("#txtAddLiability-" + vehicleGroupId).val();

                $.post("Waivers/AddWaiver", { waiver: waiverTypeId, cost: cost, liability: liability, vehicleGroupId: vehicleGroupId })
                .done(function (data) {
                    if (data == "-1") {
                        alert("An error occurred adding this waiver");
                    } else {
                        var newWaiverId = data;
                        addUpdateWaiverRow(vehicleGroupId, newWaiverId, waiverTypeId, cost, liability);
                        removeAddForm(vehicleGroupId);
                    }
                });
            });

            $("#btnCancel-" + vehicleGroupId).on("click", function (e) {
                removeAddForm(vehicleGroupId);
            });
        }

        function createEditForm(waiverId) {

            //get current data
            //$.post("manage-waivers.aspx?type=getwaiver", { waiverId: waiverId })
            $.post("/Waivers/GetWaiver", { waiverId: waiverId })
                .done(function (data) {
                    if (data == "error") {
                        alert("An error occurred retrieving this waiver");
                    } else {
                        var currentWaiverTypeId = data.WaiverType;
                        var currentCost = data.CostPerDay;
                        if (currentCost == null) {
                            currentCost = "";
                        }
                        var currentLiability = data.Liability;
                        if (currentLiability == null) {
                            currentLiability = "";
                        }

                        $("#edit-form-" + waiverId).html(getWaiverDropDownHtml("edit", waiverId, currentWaiverTypeId) + "<input type='text' placeholder='Cost Per Day' value='" + currentCost + "' id='txtEditCost-" + waiverId + "' /><input type='text' placeholder='Liability' value='" + currentLiability + "' id='txtEditLiability-" + waiverId + "' /><input id='btnUpdate-" + waiverId + "' type='button' value='Update' /><input id='btnCancelEdit-" + waiverId + "' type='button' value='Cancel' />");

                        $("#waiver-" + waiverId).hide();

                        $("#btnUpdate-" + waiverId).on("click", function (e) {
                            var waiverTypeId = $("#selEdit-" + waiverId).val();
                            var cost = $("#txtEditCost-" + waiverId).val();
                            var liability = $("#txtEditLiability-" + waiverId).val();

                            $.post("/Waivers/EditWaiver", { waiverId: waiverId, waiver: waiverTypeId, cost: cost, liability: liability })
                            .done(function (data) {
                                if (data == "-1") {
                                    alert("An error occurred updating this waiver");
                                } else {
                                    var newWaiverId = data;
                                    addUpdateWaiverRow(-1, newWaiverId, waiverTypeId, cost, liability);
                                    removeEditForm(waiverId);
                                }
                            });
                        });

                        $("#btnCancelEdit-" + waiverId).on("click", function (e) {
                            removeEditForm(waiverId);
                        });

                    }
                });




        }

        function addUpdateWaiverRow(vehicleGroupId, waiverId, waiverTypeId, cost, liability) {
            if (cost == "") {
                cost = "n/a";
            }
            if (liability == "") {
                liability = "n/a";
            }
            var waiverType = getWaiverTypeFromId(waiverTypeId);
            if (waiverType == "") {
                window.location.reload();
            } else {
                var waiverRow = $("#waiver-" + waiverId);
                if (waiverRow.length > 0) {
                    //update
                    var updatedWaiverHtml = "<span class='waiver-list-item'><a href='#edit' class='edit-waiver' id='edit-waiver-" + waiverId + "'>Edit</a></span><span class='waiver-list-item'>" + waiverType + "</span><span class='waiver-list-item'>Cost per day: " + cost + "</span><span class='waiver-list-item'>Liability: " + liability + "</span><span class='waiver-list-item'><a href='#delete' class='delete-waiver' id='delete-waiver-" + waiverId + "'>Delete</a></span>";

                    waiverRow.html(updatedWaiverHtml);
                } else {
                    //add
                    var newWaiverHtml = "<div id='waiver-" + waiverId + "'><span class='waiver-list-item'><a href='#edit' class='edit-waiver' id='edit-waiver-" + waiverId + "'>Edit</a></span><span class='waiver-list-item'>" + waiverType + "</span><span class='waiver-list-item'>Cost per day: " + cost + "</span><span class='waiver-list-item'>Liability: " + liability + "</span><span class='waiver-list-item'><a href='#delete' class='delete-waiver' id='delete-waiver-" + waiverId + "'>Delete</a></span></div>";
                    $("#waivers-list-" + vehicleGroupId).append(newWaiverHtml);
                }
            }

            $(".edit-waiver", "#waiver-" + waiverId).on("click", function (e) {
                var waiverId = $(this).attr("id").replace("edit-waiver-", "");

                if (waiverTypes == undefined) {
                    getWaiverTypes("edit", waiverId);
                } else {
                    createEditForm(waiverId);
                }

                e.preventDefault();
                return false;
            });

            $(".delete-waiver", "#waiver-" + waiverId).on("click", function (e) {
                var waiverId = $(this).attr("id").replace("delete-waiver-", "");
                if (confirm("Are you sure you'd like to delete this waiver?")) {
                    deleteWaiver(waiverId);
                }
                e.preventDefault();
                return false;
            });
        }

        function removeAddForm(vehicleGroupId) {
            $("#btnAdd-" + vehicleGroupId).off("click");
            $("#btnCancel-" + vehicleGroupId).off("click");
            $("#form-" + vehicleGroupId).html("");
        }

        function removeEditForm(waiverId) {
            $("#btnEdit-" + waiverId).off("click");
            $("#btnCancelEdit-" + waiverId).off("click");
            $("#edit-form-" + waiverId).html("");
            $("#waiver-" + waiverId).show();
        }

        function deleteWaiver(waiverId) {

            $.post("/Waivers/DeleteWaiver", { waiverId: waiverId })
              .done(function (data) {
                  if (data == "error") {
                      alert("An error occurred deleting this waiver");
                  } else {
                      $(".edit-waiver", "#waiver-" + waiverId).off("click");
                      $(".delete-waiver", "#waiver-" + waiverId).off("click");
                      $("#waiver-" + waiverId).remove();
                  }
              });
        }
    </script>
}